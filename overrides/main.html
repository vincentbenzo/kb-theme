{% extends "base.html" %}
{% block extrahead %}
{{ super() }}
<meta name="custom-override" content="active">
{% endblock %}
{% block scripts %}
{{ super() }}
<script>
  // Function to handle workspace selection
  function changeWorkspace(workspacePath) {
    if (workspacePath) {
      // Navigate to the selected workspace
      window.location.href = workspacePath;
    }
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    // Create the custom workspace selector
    const selectorContainer = document.createElement('div');
    selectorContainer.className = 'workspace-selector';
    
    // Create the dropdown trigger button
    const dropdownButton = document.createElement('div');
    dropdownButton.className = 'workspace-dropdown-button';
    dropdownButton.setAttribute('aria-label', 'Select workspace');
    dropdownButton.setAttribute('tabindex', '0');
    
    // Create the options container
    const optionsContainer = document.createElement('div');
    optionsContainer.className = 'workspace-options-container';
    optionsContainer.style.display = 'none';
    
    // Fetch workspaces configuration
    fetch('/assets/config/workspaces.yml')
      .then(response => response.text())
      .then(yamlText => {
        // Parse YAML - using a simple approach since the structure is straightforward
        const workspaces = parseWorkspacesYaml(yamlText);
        
        // Set initial selected option
        let selectedOption = workspaces[0];
        const currentUrl = window.location.href;
        
        // Create all option elements
        workspaces.forEach(option => {
          // Check if this is the current URL
          if (currentUrl.includes(option.url)) {
            selectedOption = option;
          }
          
          const optionElement = document.createElement('div');
          optionElement.className = 'workspace-option';
          optionElement.textContent = option.name;
          optionElement.dataset.value = option.url;
          
          // Add click event to option
          optionElement.addEventListener('click', function() {
            changeWorkspace(option.url);
          });
          
          optionsContainer.appendChild(optionElement);
        });
        
        // Set the button text to the selected option
        dropdownButton.textContent = selectedOption.name;
        
        // Add elements to the container
        selectorContainer.appendChild(dropdownButton);
        selectorContainer.appendChild(optionsContainer);
        
        // Find where to insert the workspace selector - after the site title
        const headerTitle = document.querySelector('.md-header__title');
        if (headerTitle && headerTitle.parentNode) {
          headerTitle.parentNode.insertBefore(selectorContainer, headerTitle.nextSibling);
        }
      })
      .catch(error => {
        console.error('Error loading workspaces configuration:', error);
        // Fallback to default workspace
        dropdownButton.textContent = 'Main';
        selectorContainer.appendChild(dropdownButton);
        const headerTitle = document.querySelector('.md-header__title');
        if (headerTitle && headerTitle.parentNode) {
          headerTitle.parentNode.insertBefore(selectorContainer, headerTitle.nextSibling);
        }
      });
    
    // Simple YAML parser for our specific format
    function parseWorkspacesYaml(yamlText) {
      const workspaces = [];
      const lines = yamlText.split('\n');
      let inWorkspaces = false;
      
      let currentWorkspace = {};
      
      lines.forEach(line => {
        if (line.trim() === 'workspaces:') {
          inWorkspaces = true;
          return;
        }
        
        if (!inWorkspaces) return;
        
        if (line.trim().startsWith('- name:')) {
          if (currentWorkspace.name) {
            workspaces.push(currentWorkspace);
          }
          currentWorkspace = {};
          currentWorkspace.name = line.split(':')[1].trim();
        } else if (line.trim().startsWith('url:')) {
          currentWorkspace.url = line.split(':')[1].trim() + (line.split(':')[2] || '');
        }
      });
      
      if (currentWorkspace.name) {
        workspaces.push(currentWorkspace);
      }
      
      return workspaces;
    }
    
    // Toggle dropdown on button click
    dropdownButton.addEventListener('click', function() {
      const isVisible = optionsContainer.style.display !== 'none';
      optionsContainer.style.display = isVisible ? 'none' : 'block';
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
      if (!selectorContainer.contains(event.target)) {
        optionsContainer.style.display = 'none';
      }
    });
    
    // Keyboard navigation
    dropdownButton.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' || e.key === ' ') {
        optionsContainer.style.display = 'block';
        e.preventDefault();
      }
    });
  });
</script>
{% endblock %}
